<!doctype html>
<html lang="ru" class="no-js">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Настройки • Planner</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg: #0b1220;
      --panel: #111a2e;
      --muted: #7b8aa1;
      --text: #e8eefc;
      --accent: #4da3ff;
      --accent-2: #7dd3fc;
      --danger: #ff6b6b;
      --ok: #22c55e;
      --border: rgba(255,255,255,.08);
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius: 16px;
    }
    @media (prefers-color-scheme: light) {
      :root{ --bg:#f6f7fb; --panel:#fff; --text:#0b1220; --muted:#5f6c80; --border:rgba(0,0,0,.08) }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 100% -200px, rgba(77,163,255,.20), transparent 60%),
                  radial-gradient(900px 700px at -10% 120%, rgba(125,211,252,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      font: 16px/1.5 system-ui, -apple-system, "Segoe UI", Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji", "Segoe UI Symbol";
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(0,0,0,.25);
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border);
    }
    .bar{
      max-width:980px; margin:0 auto; padding:14px 16px;
      display:flex; align-items:center; gap:12px;
    }
    .back{
      display:inline-flex; align-items:center; gap:8px;
      color:var(--text); text-decoration:none; padding:8px 10px;
      border:1px solid var(--border); border-radius:10px;
    }
    .back:focus-visible{outline:2px solid var(--accent)}
    .title{font-weight:700; font-size:18px; letter-spacing:.2px}
    main{max-width:980px; margin:24px auto 72px; padding:0 16px}
    .grid{
      display:grid; gap:16px;
      grid-template-columns: 1fr;
    }
    @media (min-width:900px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }
    section.card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.02)), var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    section.card h2{
      margin:0 0 12px; font-size:16px; font-weight:700; letter-spacing:.25px;
    }
    .row{
      display:grid; gap:10px; align-items:center;
      grid-template-columns: 1fr auto;
      padding:10px 0; border-top:1px dashed var(--border);
    }
    .row:first-child{border-top:none}
    .row .help{color:var(--muted); font-size:13px}
    .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-self:end }
    select, input[type="text"], input[type="time"], input[type="number"]{
      background:transparent; color:var(--text);
      border:1px solid var(--border); border-radius:12px; padding:8px 10px;
    }
    .switch{
      --w:44px; --h:28px;
      position:relative; display:inline-block; width:var(--w); height:var(--h);
    }
    .switch input{ opacity:0; width:0; height:0; }
    .slider{
      position:absolute; inset:0; border-radius:999px;
      background:#2a3550; border:1px solid var(--border);
      transition:.2s ease;
    }
    .slider::before{
      content:""; position:absolute; height:20px; width:20px; left:4px; top:50%;
      translate:0 -50%; border-radius:50%;
      background:white; transition:.2s ease;
      box-shadow:0 2px 8px rgba(0,0,0,.35);
    }
    .switch input:checked + .slider{ background: linear-gradient(90deg, var(--accent), var(--accent-2)); }
    .switch input:checked + .slider::before{ left: calc(var(--w) - 24px); }
    .btn{
      appearance:none; border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.06));
      color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{ border-color: transparent; background: linear-gradient(90deg, var(--accent), var(--accent-2)); color:#001229; font-weight:700 }
    .btn.danger{ border-color: rgba(255,0,0,.25); background:linear-gradient(180deg, rgba(255,0,0,.12), rgba(0,0,0,.06)); color:#ffdede }
    .kbd{font:12px/1.2 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; color:var(--muted)}
    .preview{
      height:40px; border-radius:10px; border:1px solid var(--border);
      background:
        radial-gradient(40px 40px at 10% -10%, rgba(77,163,255,.5), transparent 60%),
        radial-gradient(40px 40px at 90% 120%, rgba(125,211,252,.45), transparent 55%),
        #0e1629;
    }
    footer{
      position:sticky; bottom:0; z-index:10;
      background:rgba(0,0,0,.35); backdrop-filter: blur(8px);
      border-top:1px solid var(--border);
    }
    .actions{
      max-width:980px; margin:0 auto; padding:12px 16px;
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }
    .hint{color:var(--muted); font-size:12px; margin-left:auto; align-self:center}
    /* small helpers */
    .stack{display:flex; flex-direction:column}
    .stack > label{font-weight:600}
    .warn{color:var(--danger)}
    .ok{color:var(--ok)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <a class="back" href="./index.html" aria-label="Назад к приложению">
        <!-- simple chevron -->
        <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
        Назад
      </a>
      <div class="title">Настройки</div>
      <span class="hint">Изменения сохраняются на этом устройстве</span>
    </div>
  </header>

  <main>
    <div class="grid" id="settingsGrid">
      <!-- Профиль и локаль -->
      <section class="card" aria-labelledby="profileHeading">
        <h2 id="profileHeading">Профиль и локализация</h2>

        <div class="row">
          <div>
            <div>Отображаемое имя</div>
            <div class="help">Используется в приветствиях и уведомлениях</div>
          </div>
          <div class="controls"><input id="displayName" type="text" placeholder="Например, А." autocomplete="name"></div>
        </div>

        <div class="row">
          <div>
            <div>Язык интерфейса</div>
            <div class="help">Переключение языка для UI</div>
          </div>
          <div class="controls">
            <select id="language">
              <option value="ru">Русский</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <div>Часовой пояс</div>
            <div class="help">Определяем автоматически, можно переопределить</div>
          </div>
          <div class="controls">
            <select id="timezone"></select>
          </div>
        </div>

        <div class="row">
          <div>
            <div>Первый день недели</div>
            <div class="help">Как отображать сетку календаря</div>
          </div>
          <div class="controls">
            <select id="weekStart">
              <option value="monday">Понедельник</option>
              <option value="sunday">Воскресенье</option>
            </select>
          </div>
        </div>
      </section>

      <!-- Тема и внешний вид -->
      <section class="card" aria-labelledby="themeHeading">
        <h2 id="themeHeading">Тема и внешний вид</h2>

        <div class="row">
          <div>
            <div>Тема</div>
            <div class="help">Можно следовать системной</div>
          </div>
          <div class="controls">
            <select id="theme">
              <option value="system">Системная</option>
              <option value="dark">Темная</option>
              <option value="light">Светлая</option>
              <option value="amoled">AMOLED (глубокий черный)</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <div>Акцентные точки событий</div>
            <div class="help">Если маркеры «точки» на событиях перекрывают время — можно уменьшить</div>
          </div>
          <div class="controls">
            <select id="dotSize">
              <option value="normal">Обычные</option>
              <option value="small">Меньше</option>
              <option value="hidden">Скрыть</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <div>Превью</div>
            <div class="help">Быстрый вид текущей комбинации</div>
          </div>
          <div class="controls" style="min-width:200px; width: 260px">
            <div class="preview" id="themePreview" aria-hidden="true"></div>
          </div>
        </div>
      </section>

      <!-- Уведомления -->
      <section class="card" aria-labelledby="notifyHeading">
        <h2 id="notifyHeading">Уведомления</h2>

        <div class="row">
          <div>
            <div>Включить уведомления</div>
            <div class="help">Запросим разрешение у браузера</div>
          </div>
          <div class="controls">
            <label class="switch">
              <input id="notifications" type="checkbox" />
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div class="row">
          <div>
            <div>Напоминать за</div>
            <div class="help">Стандартное время до события</div>
          </div>
          <div class="controls">
            <select id="remindBefore">
              <option value="5">5 минут</option>
              <option value="10">10 минут</option>
              <option value="15">15 минут</option>
              <option value="30">30 минут</option>
              <option value="60">1 час</option>
              <option value="120">2 часа</option>
              <option value="1440">1 день</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <div>Тишина ночью</div>
            <div class="help">Не присылать пуш-уведомления в указанный интервал</div>
          </div>
          <div class="controls">
            <input id="quietFrom" type="time" value="23:00" aria-label="Начало тихого времени">
            <span class="kbd">—</span>
            <input id="quietTo" type="time" value="08:00" aria-label="Конец тихого времени">
          </div>
        </div>

        <div class="row">
          <div>
            <div>Проверка</div>
            <div class="help">Сразу увидеть, как это выглядит</div>
          </div>
          <div class="controls">
            <button class="btn" id="testNotification">Тестовое уведомление</button>
          </div>
        </div>
      </section>

      <!-- Интеграции -->
      <section class="card" aria-labelledby="integrationsHeading">
        <h2 id="integrationsHeading">Интеграции</h2>

        <div class="row">
          <div>
            <div>Импорт расписания</div>
            <div class="help">ICS/CSV из университета или Google/Apple/Outlook</div>
          </div>
          <div class="controls">
            <input id="importFile" type="file" accept=".ics,.csv" />
            <button class="btn" id="importBtn">Импорт</button>
          </div>
        </div>

        <div class="row">
          <div>
            <div>Экспорт моих данных</div>
            <div class="help">Выгрузка настроек в JSON</div>
          </div>
          <div class="controls">
            <button class="btn" id="exportSettings">Экспорт .json</button>
          </div>
        </div>
      </section>

      <!-- Данные и конфиденциальность -->
      <section class="card" aria-labelledby="privacyHeading">
        <h2 id="privacyHeading">Данные и конфиденциальность</h2>

        <div class="row">
          <div>
            <div>Локальное хранение</div>
            <div class="help">Настройки сохраняются локально в <span class="mono">localStorage</span></div>
          </div>
          <div class="controls">
            <span class="ok" id="storageStatus">ОК</span>
          </div>
        </div>

        <div class="row">
          <div>
            <div>Резервная копия</div>
            <div class="help">Скачать бэкап всех настроек</div>
          </div>
          <div class="controls">
            <button class="btn" id="backupBtn">Скачать бэкап</button>
          </div>
        </div>

        <div class="row">
          <div>
            <div class="warn">Сбросить настройки</div>
            <div class="help">Вернуть значения по умолчанию</div>
          </div>
          <div class="controls">
            <button class="btn danger" id="resetAll">Сбросить</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <div class="actions">
      <span class="hint" id="saveHint">Изменения сохраняются автоматически</span>
      <button class="btn" id="revertBtn" title="Загрузить сохранённые значения">Отменить изменения</button>
      <button class="btn primary" id="saveBtn" title="Применить и отправить в приложение">Сохранить</button>
    </div>
  </footer>

  <template id="toastTpl">
    <div role="status" aria-live="polite" style="
      position: fixed; inset: auto 16px 16px auto; padding: 10px 14px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color:#001229; border-radius:12px; box-shadow: var(--shadow); font-weight:700;">
      <span id="toastText">Сохранено</span>
    </div>
  </template>

  <script>
    // ------- минимальная шина событий для связи со всем приложением
    function dispatchSettingsChanged(payload){
      const evt = new CustomEvent('app:settings:changed', { detail: payload });
      window.dispatchEvent(evt);
    }

    // ------- ключ и значения по умолчанию
    const STORAGE_KEY = 'planner.settings.v1';
    const defaults = {
      displayName: '',
      language: 'ru',
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Moscow',
      weekStart: 'monday',
      theme: 'system',     // system | dark | light | amoled
      dotSize: 'normal',   // normal | small | hidden
      notifications: false,
      remindBefore: 15,    // minutes
      quietFrom: '23:00',
      quietTo: '08:00'
    };

    const els = {};

    function $(id){ return document.getElementById(id); }

    function loadSaved(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? { ...defaults, ...JSON.parse(raw) } : { ...defaults };
      }catch(e){
        console.warn('Не удалось загрузить настройки:', e);
        $('storageStatus').textContent = 'Ошибка';
        $('storageStatus').classList.remove('ok');
        $('storageStatus').classList.add('warn');
        return { ...defaults };
      }
    }

    function saveCurrent(values){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(values));
        toast('Сохранено');
        dispatchSettingsChanged(values);
      }catch(e){
        toast('Ошибка сохранения', true);
      }
    }

    function toast(text, isError=false){
      const tpl = $('toastTpl').content.cloneNode(true);
      const node = tpl.querySelector('div'); const span = tpl.querySelector('#toastText');
      span.textContent = text;
      if(isError){ node.style.background = 'linear-gradient(90deg, #ff8a8a, #ff6b6b)'; node.style.color = '#1a0000'; }
      document.body.appendChild(node);
      setTimeout(()=> node.remove(), 1800);
    }

    // ------- заполнение списка таймзон (простая версия)
    const timezones = (()=> {
      // Короткий список популярных + текущий
      const base = [
        'Europe/Paris','Europe/Moscow','Europe/Berlin','Europe/London',
        'Asia/Dubai','Asia/Tokyo','Asia/Shanghai','America/New_York',
        'America/Los_Angeles','UTC'
      ];
      const current = Intl.DateTimeFormat().resolvedOptions().timeZone;
      if(current && !base.includes(current)) base.unshift(current);
      return [...new Set(base)];
    })();

    function populateTimezoneSelect(){
      const tzSel = $('timezone');
      tzSel.innerHTML = '';
      timezones.forEach(tz=>{
        const opt = document.createElement('option');
        opt.value = tz; opt.textContent = tz;
        tzSel.appendChild(opt);
      });
    }

    function applyThemePreview(value){
      // Для AMOLED чуть меняем фон
      const prev = $('themePreview');
      if(value === 'amoled'){
        prev.style.background = '#000';
      } else if(value === 'light'){
        prev.style.background = '#fff';
      } else {
        prev.removeAttribute('style');
        prev.className = 'preview';
      }
    }

    function readFromUI(){
      return {
        displayName: $('displayName').value.trim(),
        language: $('language').value,
        timezone: $('timezone').value,
        weekStart: $('weekStart').value,
        theme: $('theme').value,
        dotSize: $('dotSize').value,
        notifications: $('notifications').checked,
        remindBefore: Number($('remindBefore').value),
        quietFrom: $('quietFrom').value,
        quietTo: $('quietTo').value
      };
    }

    function writeToUI(v){
      $('displayName').value = v.displayName;
      $('language').value = v.language;
      $('timezone').value = v.timezone;
      $('weekStart').value = v.weekStart;
      $('theme').value = v.theme;
      $('dotSize').value = v.dotSize;
      $('notifications').checked = v.notifications;
      $('remindBefore').value = String(v.remindBefore);
      $('quietFrom').value = v.quietFrom;
      $('quietTo').value = v.quietTo;
      applyThemePreview(v.theme);
    }

    async function ensureNotificationPermission(checked){
      if(!checked) return;
      if(!('Notification' in window)){ toast('Браузер не поддерживает уведомления', true); return; }
      if(Notification.permission === 'granted') return;
      if(Notification.permission === 'denied'){ toast('Уведомления запрещены в браузере', true); return; }
      try{
        const res = await Notification.requestPermission();
        if(res !== 'granted'){
          $('notifications').checked = false;
          toast('Разрешение не выдано', true);
        }
      }catch(e){
        $('notifications').checked = false;
        toast('Не удалось запросить разрешение', true);
      }
    }

    function withinQuietHours(start, end, now = new Date()){
      // Поддержка интервалов через полночь
      const [sh, sm] = start.split(':').map(Number);
      const [eh, em] = end.split(':').map(Number);
      const s = sh*60+sm, e = eh*60+em;
      const cur = now.getHours()*60 + now.getMinutes();
      return (s <= e) ? (cur >= s && cur <= e) : (cur >= s || cur <= e);
    }

    function testNotify(){
      const v = readFromUI();
      ensureNotificationPermission(true).then(()=>{
        if(('Notification' in window) && Notification.permission === 'granted'){
          if(withinQuietHours(v.quietFrom, v.quietTo)){
            toast('Сейчас «тихое время» — пуш не показан');
            return;
          }
          const n = new Notification('Planner • Проверка', {
            body: 'Так будет выглядеть напоминание о событии.',
            tag: 'planner-test',
          });
          setTimeout(()=> n.close(), 4000);
        }else{
          toast('Нет разрешения на уведомления', true);
        }
      });
    }

    function exportSettings(){
      const data = readFromUI();
      const blob = new Blob([JSON.stringify({ version:1, exportedAt: new Date().toISOString(), data }, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), { href:url, download:'planner-settings.json' });
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function backupAll(){
      // Пока — то же, что экспорт (хуки под расширение)
      exportSettings();
    }

    function importSettings(file){
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const parsed = JSON.parse(reader.result);
          const data = parsed.data || parsed; // поддержим «чистый» json
          localStorage.setItem(STORAGE_KEY, JSON.stringify({ ...defaults, ...data }));
          writeToUI({ ...defaults, ...data });
          toast('Импортировано');
          dispatchSettingsChanged(data);
        }catch(e){
          toast('Файл не распознан', true);
        }
      };
      reader.readAsText(file);
    }

    function resetAll(){
      if(!confirm('Сбросить все настройки к значениям по умолчанию?')) return;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(defaults));
      writeToUI(defaults);
      toast('Сброшено');
      dispatchSettingsChanged(defaults);
    }

    // ---------- ИНИЦИАЛИЗАЦИЯ
    document.addEventListener('DOMContentLoaded', ()=>{
      populateTimezoneSelect();

      const saved = loadSaved();
      writeToUI(saved);

      // элементы
      els.saveBtn = $('saveBtn');
      els.revertBtn = $('revertBtn');
      els.resetAll = $('resetAll');
      els.exportSettings = $('exportSettings');
      els.backupBtn = $('backupBtn');
      els.importBtn = $('importBtn');
      els.importFile = $('importFile');
      els.testNotification = $('testNotification');

      // события
      $('theme').addEventListener('change', e=> applyThemePreview(e.target.value));
      $('notifications').addEventListener('change', e=> ensureNotificationPermission(e.target.checked));
      els.testNotification.addEventListener('click', testNotify);

      // авто-сейв при изменениях (с дебаунсом)
      let t;
      document.getElementById('settingsGrid').addEventListener('input', ()=>{
        clearTimeout(t); t = setTimeout(()=> saveCurrent(readFromUI()), 400);
      });
      document.getElementById('settingsGrid').addEventListener('change', ()=>{
        clearTimeout(t); t = setTimeout(()=> saveCurrent(readFromUI()), 200);
      });

      els.saveBtn.addEventListener('click', ()=> saveCurrent(readFromUI()));
      els.revertBtn.addEventListener('click', ()=> writeToUI(loadSaved()));
      els.resetAll.addEventListener('click', resetAll);
      els.exportSettings.addEventListener('click', exportSettings);
      els.backupBtn.addEventListener('click', backupAll);
      els.importBtn.addEventListener('click', ()=> importSettings(els.importFile.files[0]));

      // Хук для основной страницы: можно прочитать настройки сразу
      dispatchSettingsChanged(saved);
    });
  </script>
</body>
</html>
