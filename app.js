/* ===================== WEEPL v3.0 =====================
 - –ì–ª–∞–≤–Ω–∞—è:
    ‚Ä¢ –ü–æ—è—Å –¥–∞—Ç, —Å–µ–≥–æ–¥–Ω—è –ø–æ —Ü–µ–Ω—Ç—Ä—É
    ‚Ä¢ –°–µ–∫—Ü–∏–∏: –°–æ–±—ã—Ç–∏—è (—Ç–∞–π–º–ª–∞–π–Ω 06‚Äì20, —à–∞–≥ 15 –º) + –ó–∞–¥–∞—á–∏ (—Å–∫—Ä–æ–ª–ª)
    ‚Ä¢ –°–≤–∞–π–ø—ã –∑–∞–¥–∞—á: –≤–ø—Ä–∞–≤–æ ‚Äî done, –≤–ª–µ–≤–æ ‚Äî –ø–µ—Ä–µ–Ω–æ—Å (FIX: –æ—Ç–º–µ–Ω–∞ –Ω–µ —Å–∫—Ä—ã–≤–∞–µ—Ç)
 - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ:
    ‚Ä¢ –ë—ã—Å—Ç—Ä—ã–π –¥–∏–∞–ª–æ–≥: –ó–∞–¥–∞—á–∞ / –°–æ–±—ã—Ç–∏–µ
 - –ö–∞–ª–µ–Ω–¥–∞—Ä—å, –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
    ‚Ä¢ –ö–æ–ª—å—Ü–æ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º –ø–æ —Ü–µ–Ω—Ç—Ä—É
 - –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∏–∂–Ω–µ–π –ø–∞–Ω–µ–ª—å—é
 - –ù–∞—Å—Ç—Ä–æ–π–∫–∏: —Ç–µ–º–∞/–∞–∫—Ü–µ–Ω—Ç/—Å—Ç–∏–ª—å/–º–∞—Å—à—Ç–∞–± (persist)
======================================================= */

const qs  = (s,p=document)=>p.querySelector(s);
const qsa = (s,p=document)=>[...p.querySelectorAll(s)];
const esc = s => String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
const sameDay=(a,b)=>a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();
const toISO = d=>new Date(d.getFullYear(),d.getMonth(),d.getDate()).toISOString().slice(0,10);
const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x;};
const addMonths=(d,n)=>{const x=new Date(d);x.setMonth(x.getMonth()+n);return x;};
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const timeToMin = t => { if(!t) return null; const m=/^(\d{1,2}):(\d{2})$/.exec(t.trim()); return m?+m[1]*60+ +m[2]:null; };

const H_START = 6, H_END = 20, HOUR_PX = 48, SLOT_MIN = 15;

let state = {
  view: 'home',
  currentDate: new Date(),
  tasks: JSON.parse(localStorage.getItem('tasks')||'[]'),
  events: JSON.parse(localStorage.getItem('events')||'[]'),
  settings: JSON.parse(localStorage.getItem('settings')||'{}')
};

function saveTasks(){ localStorage.setItem('tasks', JSON.stringify(state.tasks)); }
function saveEvents(){ localStorage.setItem('events', JSON.stringify(state.events)); }
function saveSettings(){ localStorage.setItem('settings', JSON.stringify(state.settings)); }

window.addEventListener('DOMContentLoaded', () => {
  wireStaticUI();
  applySettingsUI();
  initNav();
  initAddDialogs();
  initRescheduleDialog();
  renderAll();              // –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
  centerTodayInStrip();     // —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
  startNowTicker();         // –ø–æ–∑–∏—Ü–∏—è ¬´—Å–µ–π—á–∞—Å¬ª –≤ —Å–æ–±—ã—Ç–∏—è—Ö
});

/* ============== NAVIGATION (bottom bar & views) ============== */
function setView(view){
  state.view=view;
  // —Ç–∞–±–±–∞—Ä
  qsa('.bottombar .navbtn').forEach(a=>a.classList.toggle('active', a.dataset.view===view));
  // —Å–µ–∫—Ü–∏–∏
  const show = id => qs(id).style.display='block';
  const hide = id => qs(id).style.display='none';
  // –≥–ª–∞–≤–Ω–∞—è ‚Äî —ç—Ç–æ –≤—Å—ë, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ #app (–±–ª–æ–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  // —É –Ω–∞—Å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è Calendar/Stats/Settings
  if(view==='home'){
    qsa('#app > .section').forEach(s=>s.style.display='block');
    hide('#viewCalendar'); hide('#viewStats'); hide('#viewSettings');
  }else{
    qsa('#app > .section').forEach(s=>s.style.display='none');
    if(view==='calendar') { show('#viewCalendar'); renderCalendar(); }
    if(view==='stats')    { show('#viewStats');    renderStats(); }
    if(view==='settings') { show('#viewSettings'); bindSettingsControls(); }
  }
}
function initNav(){
  // –Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å
  qs('#tabHome').onclick     =()=> setView('home');
  qs('#tabCalendar').onclick =()=> setView('calendar');
  qs('#tabStats').onclick    =()=> setView('stats');
  qs('#tabSettings').onclick =()=> setView('settings');
  // FAB
  qs('#fab').onclick = ()=> openAddDialog();
  // –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–µ—Å—è—Ü–∞ (–Ω–∞ –≥–ª–∞–≤–Ω–æ–π)
  qs('#btnPrevMonth')?.addEventListener('click',()=>{ state.currentDate=addMonths(state.currentDate,-1); renderAll(); });
  qs('#btnNextMonth')?.addEventListener('click',()=>{ state.currentDate=addMonths(state.currentDate, 1); renderAll(); });
}

/* =================== HOME RENDER =================== */
function renderAll(){
  renderMonthHeader();
  renderDateStrip();
  renderDayGrid();     // —Å–æ–±—ã—Ç–∏—è
  renderTasksList();   // –∑–∞–¥–∞—á–∏
  renderCalendar();    // –∫–∞–ª–µ–Ω–¥–∞—Ä—å –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∫—Ä—ã—Ç, –Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º
  renderStats();       // –æ–±–Ω–æ–≤–∏–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã
}

function renderMonthHeader(){
  const t = state.currentDate.toLocaleString('ru-RU',{month:'long', year:'numeric'});
  const el = qs('#monthTitle'); if(el) el.textContent = t.charAt(0).toUpperCase()+t.slice(1);
}

function renderDateStrip(){
  const strip = qs('#dateStrip'); if(!strip) return;
  strip.innerHTML='';
  const y=state.currentDate.getFullYear(), m=state.currentDate.getMonth();
  const days = new Date(y,m+1,0).getDate();
  const today = new Date();

  for(let i=1;i<=days;i++){
    const d=new Date(y,m,i);
    const pill=document.createElement('div');
    pill.className='date-pill'+(sameDay(d,state.currentDate)?' active':'');
    pill.innerHTML = `
      <div class="wk">${d.toLocaleDateString('ru-RU',{weekday:'short'})}</div>
      <div class="daynum">${i}</div>
      <div class="mon">${d.toLocaleDateString('ru-RU',{month:'short'})}</div>`;
    pill.onclick=()=>{ state.currentDate=d; renderAll(); centerActiveInStrip(); };
    strip.appendChild(pill);
  }
}
function centerTodayInStrip(){ centerActiveInStrip(true); }
function centerActiveInStrip(initialize=false){
  const strip=qs('#dateStrip'); if(!strip) return;
  const active=qs('.date-pill.active',strip);
  if(active){
    const offset = active.offsetLeft - (strip.clientWidth/2 - active.clientWidth/2);
    strip.scrollTo({left: Math.max(offset,0), behavior: initialize?'auto':'smooth'});
  }
}

/* =================== EVENTS TIMELINE (06‚Äì20) =================== */
function renderDayGrid(){
  // –≤—Ä–µ–º—è-—Ç–∏–∫–∏
  const ticks=qs('#timeTicks'); const col=qs('#eventsCol'); if(!ticks||!col) return;
  ticks.innerHTML='';
  for(let h=H_START; h<=H_END; h++){
    const tick=document.createElement('div');
    tick.className='tick';
    tick.textContent = `${String(h).padStart(2,'0')}:00`;
    ticks.appendChild(tick);
  }

  // ¬´—Å–µ–π—á–∞—Å¬ª –ª–∏–Ω–∏—è
  const nowLine = qs('#nowLine');
  const now = new Date();
  if(sameDay(now, state.currentDate) && now.getHours()>=H_START && now.getHours()<=H_END){
    const mins = (now.getHours()-H_START)*60 + now.getMinutes();
    nowLine.style.display='block';
    nowLine.style.top = `${mins/60*HOUR_PX}px`;
  }else{
    nowLine.style.display='none';
  }

  // —Å–æ–±—ã—Ç–∏—è —ç—Ç–æ–≥–æ –¥–Ω—è
  col.innerHTML = nowLine.outerHTML; // –≤—Å—Ç–∞–≤–∏–º –ª–∏–Ω–∏—é –æ–±—Ä–∞—Ç–Ω–æ –ø–µ—Ä–≤—ã–º —Ä–µ–±—ë–Ω–∫–æ–º
  const iso = toISO(state.currentDate);
  const dayEvents = state.events
    .filter(e=>e.date===iso)
    .map(e=>({ ...e, s: timeToMin(e.start), eMin: timeToMin(e.end) }))
    .filter(e=> e.s!=null && e.eMin!=null && e.eMin>e.s)
    .sort((a,b)=> a.s-b.s);

  // –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
  dayEvents.forEach(ev=>{
    const topPx = ((ev.s - H_START*60)/60)*HOUR_PX;
    const heightPx = Math.max((ev.eMin - ev.s)/60*HOUR_PX, HOUR_PX*(SLOT_MIN/60));
    const div=document.createElement('div');
    div.className='event';
    div.style.setProperty('--top', `${topPx}px`);
    div.style.setProperty('--h', `${heightPx}px`);
    div.innerHTML = `<div class="title">${esc(ev.title)}</div>
                     <div class="time">${ev.start} ‚Äì ${ev.end}</div>`;
    // –∫–ª–∏–∫ ‚Äî –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ (–ø–æ–∫–∞ –±–µ–∑ —Å–≤–∞–π–ø–∞ –¥–ª—è —Å–æ–±—ã—Ç–∏–π)
    div.onclick=()=> openReschedule(ev.id, 'event');
    col.appendChild(div);
  });
}

/* =================== TASKS LIST (—Å–≤–∞–π–ø—ã) =================== */
function renderTasksList(){
  const list = qs('#taskList'); if(!list) return;
  const iso = toISO(state.currentDate);
  const arr = state.tasks.filter(t=>t.date===iso).sort((a,b)=>{
    const am = timeToMin(a.time)??1441, bm = timeToMin(b.time)??1441;
    return am-bm;
  });

  qs('#todayCounter').textContent = `–ó–∞–¥–∞—á: ${arr.length}`;

  if(arr.length===0){ list.innerHTML=''; return; }

  list.innerHTML = arr.map(t=>{
    const meta = [t.time||'‚Äî', `–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${t.priority||'—Å—Ä–µ–¥–Ω–∏–π'}`].join(' ‚Ä¢ ');
    return `<div class="t-item${t.done?' done':''}" data-id="${t.id}" style="touch-action: pan-y;">
      <div class="row1">
        <div class="t-title">${esc(t.title)}</div>
        <div class="task-ctl">
          <button class="icon-btn" data-act="done" data-id="${t.id}" title="–ì–æ—Ç–æ–≤–æ">‚úî</button>
          <button class="icon-btn" data-act="move" data-id="${t.id}" title="–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏">‚Üî</button>
          <button class="icon-btn" data-act="del"  data-id="${t.id}" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
        </div>
      </div>
      <div class="t-meta">${meta}</div>
    </div>`;
  }).join('');

  // –∫–Ω–æ–ø–∫–∏
  qsa('.task-ctl .icon-btn', list).forEach(b=>{
    const id=b.dataset.id, act=b.dataset.act;
    if(act==='done') b.onclick=()=> toggleDoneTask(id);
    if(act==='del')  b.onclick=()=> deleteTask(id);
    if(act==='move') b.onclick=()=> openReschedule(id,'task');
  });

  // —Å–≤–∞–π–ø—ã
  qsa('.t-item', list).forEach(attachSwipe);
}

function toggleDoneTask(id){
  const t=state.tasks.find(x=>x.id===id); if(!t) return;
  t.done=!t.done; saveTasks(); renderTasksList(); renderStats();
}
function deleteTask(id){
  state.tasks=state.tasks.filter(t=>t.id!==id); saveTasks(); renderTasksList(); renderStats();
}

/* ============== SWIPE (tasks) ============== */
function attachSwipe(el){
  let startX=0, curX=0, dragging=false, id=el.dataset.id;
  const THRESH=64;

  const onStart=x=>{ dragging=true; startX=x; el.style.transition='none'; };
  const onMove =x=>{
    if(!dragging) return;
    curX=x-startX;
    const dx=clamp(curX,-120,120);
    el.style.transform=`translateX(${dx}px)`; el.style.opacity=String(1-Math.min(Math.abs(dx)/220,.4));
  };
  const onEnd =()=>{
    if(!dragging) return;
    el.style.transition='transform .18s, opacity .18s';
    if(curX>THRESH){ el.style.transform='translateX(100%)'; el.style.opacity='0'; setTimeout(()=>toggleDoneTask(id),140); }
    else if(curX<-THRESH){ openReschedule(id,'task', /*fromSwipe*/true); }  // FIX: –Ω–µ —Å–∫—Ä—ã–≤–∞–µ–º
    else resetSwipeVisual(id);
    dragging=false; startX=curX=0;
  };

  el.addEventListener('mousedown',e=>onStart(e.clientX));
  window.addEventListener('mousemove',e=>onMove(e.clientX));
  window.addEventListener('mouseup', onEnd);
  el.addEventListener('touchstart',e=>onStart(e.touches[0].clientX),{passive:true});
  el.addEventListener('touchmove', e=>onMove(e.touches[0].clientX),{passive:true});
  el.addEventListener('touchend', onEnd);
}

function resetSwipeVisual(id){
  const el=document.querySelector(`.t-item[data-id="${CSS.escape(id)}"]`);
  if(el){ el.style.transition='transform .18s, opacity .18s'; el.style.transform='translateX(0)'; el.style.opacity='1'; }
}

/* =================== ADD DIALOGS =================== */
function wireStaticUI(){
  // —Ç–æ–ø-–∫–Ω–æ–ø–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ ¬´–°–µ–≥–æ–¥–Ω—è¬ª
  qs('#btnAddTaskTop')?.addEventListener('click',()=> openAddDialog('task'));
  qs('#btnAddEventTop')?.addEventListener('click',()=> openAddDialog('event'));
}
function openAddDialog(tab='choice'){
  const dlg=qs('#dlgAdd'); if(!dlg) return;
  dlg.showModal();
  showAddTab(tab);
}
function showAddTab(tab){
  const fTask=qs('#formTask'), fEvent=qs('#formEvent');
  if(tab==='task'){ fTask.style.display='block'; fEvent.style.display='none'; }
  else if(tab==='event'){ fTask.style.display='none'; fEvent.style.display='block'; }
  else{ fTask.style.display='block'; fEvent.style.display='none'; }
}
function initAddDialogs(){
  const dlg=qs('#dlgAdd'); if(!dlg) return;
  // –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏
  qs('#dlgAddClose').onclick = ()=> dlg.close();
  qs('#openAddTask').onclick = ()=> showAddTab('task');
  qs('#openAddEvent').onclick= ()=> showAddTab('event');
  qs('#cancelTask').onclick  = ()=> dlg.close();
  qs('#cancelEvent').onclick = ()=> dlg.close();
  // –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  const todayISO = toISO(state.currentDate);
  qs('#taskDate').value = todayISO;
  qs('#eventDate').value = todayISO;

  // submit: task
  qs('#formTask').onsubmit = e=>{
    e.preventDefault();
    const title = qs('#taskTitle').value.trim();
    if(!title) return;
    const t = {
      id: cryptoRandom(),
      title,
      date: qs('#taskDate').value || todayISO,
      time: qs('#taskTime').value || '',
      priority: mapPriority(qs('#taskPriority').value),
      note: qs('#taskNote').value || '',
      done:false
    };
    state.tasks.push(t); saveTasks(); dlg.close(); renderTasksList(); renderStats();
  };
  // submit: event
  qs('#formEvent').onsubmit = e=>{
    e.preventDefault();
    const title = qs('#eventTitle').value.trim();
    if(!title) return;
    const start = qs('#eventStart').value;
    const end   = qs('#eventEnd').value;
    if(!start || !end) { alert('–£–∫–∞–∂–∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞'); return; }
    if(timeToMin(end) <= timeToMin(start)){ alert('–í—Ä–µ–º—è –∫–æ–Ω—Ü–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–∑–∂–µ –Ω–∞—á–∞–ª–∞'); return; }
    const ev = {
      id: cryptoRandom(),
      title,
      date: qs('#eventDate').value || todayISO,
      start, end,
      priority: mapPriority(qs('#eventPriority').value),
      location: qs('#eventLocation').value || '',
      note: qs('#eventNote').value || ''
    };
    state.events.push(ev); saveEvents(); dlg.close(); renderDayGrid();
  };
}
function mapPriority(txt){
  const t=txt.toLowerCase();
  if(t.startsWith('–Ω–∏–∑')) return 'low';
  if(t.startsWith('–≤—ã—Å')) return 'high';
  if(t.startsWith('–∫—Ä–∏—Ç')) return 'critical';
  return 'medium';
}
function cryptoRandom(){
  if(window.crypto?.getRandomValues){
    const arr=new Uint32Array(2); crypto.getRandomValues(arr);
    return (Date.now().toString(36)+arr[0].toString(36)+arr[1].toString(36)).slice(0,16);
  }
  return Date.now().toString(36)+Math.random().toString(36).slice(2,6);
}

/* =================== RESCHEDULE (task & event) =================== */
let resTarget = { id:null, kind:null }; // kind: 'task'|'event'
function initRescheduleDialog(){
  const dlg=qs('#dlgReschedule'); if(!dlg) return;
  qs('#dlgRescheduleClose').onclick = ()=> closeReschedule();
  qs('#moveCancel').onclick         = ()=> closeReschedule();
  qs('#moveApply').onclick          = applyReschedule;
}
function openReschedule(id, kind, fromSwipe=false){
  resTarget={id,kind};
  const dlg=qs('#dlgReschedule'); if(!dlg) return;
  // –∑–∞–ø–æ–ª–Ω–∏–º —Ç–µ–∫—É—â–∏–µ
  if(kind==='task'){
    const t=state.tasks.find(x=>x.id===id); if(!t) return;
    qs('#moveDate').value = t.date || toISO(state.currentDate);
    qs('#moveTime').value = t.time || '';
    if(fromSwipe) resetSwipeVisual(id);
  }else{
    const e=state.events.find(x=>x.id===id); if(!e) return;
    qs('#moveDate').value = e.date || toISO(state.currentDate);
    qs('#moveTime').value = e.start || '';
  }
  dlg.showModal();
}
function closeReschedule(){
  const dlg=qs('#dlgReschedule'); dlg?.close();
  // –≤–∏–∑—É–∞–ª—å–Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞–¥–∞—á–∏ –Ω–∞ –º–µ—Å—Ç–æ (—Ñ–∏–∫—Å –±–∞–≥–∞)
  if(resTarget.kind==='task') resetSwipeVisual(resTarget.id);
  resTarget={id:null,kind:null};
}
function applyReschedule(){
  const date=qs('#moveDate').value, time=qs('#moveTime').value;
  if(resTarget.kind==='task'){
    const t=state.tasks.find(x=>x.id===resTarget.id); if(!t) return;
    if(date) t.date=date;
    if(time) t.time=time;
    saveTasks(); renderTasksList();
  }else if(resTarget.kind==='event'){
    const e=state.events.find(x=>x.id===resTarget.id); if(!e) return;
    if(date) e.date=date;
    if(time){ // —Å–¥–≤–∏–≥–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª, —Å–æ—Ö—Ä–∞–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
      const dur = timeToMin(e.end) - timeToMin(e.start);
      e.start=time;
      const endMin = timeToMin(time)+dur;
      const hh=String(Math.floor(endMin/60)).padStart(2,'0');
      const mm=String(endMin%60).padStart(2,'0');
      e.end = `${hh}:${mm}`;
    }
    saveEvents(); renderDayGrid();
  }
  closeReschedule();
}

/* =================== CALENDAR =================== */
function renderCalendar(){
  const grid=qs('#calendarGrid'); const title=qs('#calTitle'); if(!grid||!title) return;
  grid.innerHTML='';
  const d=state.currentDate, y=d.getFullYear(), m=d.getMonth();
  title.textContent = d.toLocaleString('ru-RU',{month:'long',year:'numeric'});

  // –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ —É–∂–µ –≤ —Ä–∞–∑–º–µ—Ç–∫–µ
  const first=new Date(y,m,1);
  const offset=(first.getDay()+6)%7; // –ü–Ω=0
  for(let i=0;i<offset;i++){ const e=document.createElement('div'); e.className='cell'; grid.appendChild(e); }

  const days=new Date(y,m+1,0).getDate();
  for(let i=1;i<=days;i++){
    const date=new Date(y,m,i), iso=toISO(date);
    const dayTasks=state.tasks.filter(t=>t.date===iso);
    const c=document.createElement('div'); c.className='cell';
    c.innerHTML=`<div class="dhead">${i}</div>
                 <div class="dots">${dayTasks.map(t=>`<span class="dot" style="background:${priorityDot(t.priority)}"></span>`).join('')}</div>`;
    if(sameDay(date,new Date())) c.classList.add('today');
    c.onclick=()=>{ state.currentDate=date; setView('home'); renderAll(); centerActiveInStrip(); };
    grid.appendChild(c);
  }

  // –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
  qs('#calPrev')?.addEventListener('click',()=>{ state.currentDate=addMonths(state.currentDate,-1); renderCalendar(); });
  qs('#calNext')?.addEventListener('click',()=>{ state.currentDate=addMonths(state.currentDate, 1); renderCalendar(); });
}
function priorityDot(p){
  if(p==='low') return '#bfbfbf';
  if(p==='high') return '#ff4fa3';
  if(p==='critical') return '#8a2be2';
  return 'var(--accent)';
}

/* =================== STATS =================== */
function renderStats(){
  // –Ω–µ–¥–µ–ª—è: –≤—Å–µ –∑–∞–¥–∞—á–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
  const now=new Date(), weekAgo=addDays(now,-7), monthAgo=addMonths(now,-1);
  const week = state.tasks.filter(t=> new Date(t.date) >= new Date(weekAgo.toDateString()));
  const weekDone= week.filter(t=>t.done);
  const pct = week.length ? Math.round(weekDone.length/week.length*100) : 0;

  const ring = qs('#ringFg'); const val=qs('#ringVal');
  if(ring){ ring.style.strokeDashoffset = (326 - 326*pct/100); }
  if(val){ animateNumber(val, pct, v=> val.textContent = `${v}%`); }

  const weekAll=week.length, monAll=state.tasks.filter(t=> new Date(t.date)>=monthAgo).length;
  const weekDoneN=weekDone.length, monDoneN=state.tasks.filter(t=> new Date(t.date)>=monthAgo && t.done).length;
  const streak = calcStreak();

  if(qs('#kpi7'))   qs('#kpi7').textContent   = `${weekDoneN}/${weekAll}`;
  if(qs('#kpiMon')) qs('#kpiMon').textContent = `${monDoneN}/${monAll}`;
  if(qs('#streak')) qs('#streak').textContent = String(streak);
}
function calcStreak(){
  const days=[...new Set(state.tasks.filter(t=>t.done).map(t=>t.date))].sort();
  let max=0,cur=0,last=null;
  for(const iso of days){
    const d=new Date(iso);
    if(last && (d-last)/86400000===1) cur++; else cur=1;
    if(cur>max) max=cur; last=d;
  }
  return max;
}
function animateNumber(el, target, draw){
  const start = Number((el.textContent||'0').replace('%',''))||0;
  const t0=performance.now(), dur=500;
  function step(t){
    const k=clamp((t-t0)/dur,0,1);
    const v=Math.round(start + (target-start)*k);
    draw(v);
    if(k<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* =================== SETTINGS (theme/accent) =================== */
function applySettingsUI(){
  const s=state.settings||{};
  document.documentElement.dataset.theme  = s.theme || 'light';
  document.documentElement.dataset.accent = (s.accent==='custom'?'custom':(s.accent||'violet'));
  document.documentElement.dataset.accentstyle = s.accentStyle || 'solid';
  document.documentElement.style.setProperty('--scale', String(s.scale||1));
  if(s.accent==='custom' && s.accentCustom){
    document.documentElement.style.setProperty('--accent', s.accentCustom);
  }
  // –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—ã (–µ—Å–ª–∏ —É–∂–µ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω—ã)
  const dark = qs('#toggleDark'); if(dark) dark.checked = (s.theme==='dark');
  const ap = qs('#accentPreset'); if(ap) ap.value = s.accent || 'violet';
  const ac = qs('#accentCustom'); if(ac) ac.value = s.accentCustom || '#7b61ff';
  const as = qs('#accentStyle');  if(as) as.value = s.accentStyle || 'solid';
  const fs = qs('#fontScale');    if(fs) fs.value = s.fontScale || '1';
}
function bindSettingsControls(){
  // –≤–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ)
  const dark = qs('#toggleDark'); if(dark && !dark._bound){
    dark._bound=true;
    dark.onchange = ()=>{ state.settings.theme= dark.checked?'dark':'light'; applySettingsUI(); saveSettings(); };
  }
  const ap = qs('#accentPreset'); if(ap && !ap._bound){
    ap._bound=true;
    ap.onchange = ()=>{
      state.settings.accent = ap.value;
      if(ap.value!=='custom') delete state.settings.accentCustom;
      applySettingsUI(); saveSettings();
    };
  }
  const ac = qs('#accentCustom'); if(ac && !ac._bound){
    ac._bound=true;
    ac.oninput = ()=>{
      state.settings.accent='custom';
      state.settings.accentCustom = ac.value;
      applySettingsUI(); saveSettings();
    };
  }
  const as = qs('#accentStyle'); if(as && !as._bound){
    as._bound=true;
    as.onchange = ()=>{ state.settings.accentStyle=as.value; applySettingsUI(); saveSettings(); };
  }
  const fs = qs('#fontScale'); if(fs && !fs._bound){
    fs._bound=true;
    fs.onchange = ()=>{
      const v=fs.value; // '1'|'2'|'3'
      state.settings.fontScale=v;
      state.settings.scale = (v==='1'?1 : v==='2'?1.10 : 1.20);
      applySettingsUI(); saveSettings();
    };
  }
}

/* =================== HELPERS =================== */
function startNowTicker(){
  // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é ¬´—Å–µ–π—á–∞—Å¬ª
  setInterval(()=>{ if(state.view==='home') renderDayGrid(); }, 60*1000);
}
