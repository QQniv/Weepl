/* Weepl App.js ‚Äî safe build v1.5.1 */
(() => {
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => [...r.querySelectorAll(s)];
  const fmt2 = n => String(n).padStart(2,'0');
  const toKey = d => `${d.getFullYear()}-${fmt2(d.getMonth()+1)}-${fmt2(d.getDate())}`;
  const fromKey = k => { const [Y,M,D]=k.split('-').map(Number); return new Date(Y, M-1, D); };
  const startDay = d => new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const addDays = (d,n)=> new Date(d.getFullYear(), d.getMonth(), d.getDate()+n);
  const RU_MON = ["—è–Ω–≤–∞—Ä—å","—Ñ–µ–≤—Ä–∞–ª—å","–º–∞—Ä—Ç","–∞–ø—Ä–µ–ª—å","–º–∞–π","–∏—é–Ω—å","–∏—é–ª—å","–∞–≤–≥—É—Å—Ç","—Å–µ–Ω—Ç—è–±—Ä—å","–æ–∫—Ç—è–±—Ä—å","–Ω–æ—è–±—Ä—å","–¥–µ–∫–∞–±—Ä—å"];
  const RU_DOW = ["–≤—Å","–ø–Ω","–≤—Ç","—Å—Ä","—á—Ç","–ø—Ç","—Å–±"];
  const sum = a => a.reduce((x,y)=>x+y,0);
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

  const storeKey = 'weepl_v1';
  const state = {
    selectedDate: startDay(new Date()),
    monthCursor: startDay(new Date()),
    items: [],
    settings: { accent: '#5b5bf0' }
  };

  // Mount template inside #viewContainer
  const root = $('#viewContainer');
  if (!root) { console.error('‚ùå viewContainer not found'); return; }
  root.innerHTML = `
    <section id="todayView" class="view is-active">
      <div class="date-scroller" id="dateScroller"></div>
      <div class="timeline-wrap"><div class="timeline" id="timeline"></div></div>
      <div class="tasklist-wrap">
        <div class="section-head"><h2>–ó–∞–¥–∞—á–∏</h2><div id="kpiCounter"></div></div>
        <ul class="task-list" id="taskList"></ul>
      </div>
    </section>

    <section id="calendarView" class="view">
      <div class="cal-head">
        <button class="icon-btn" id="calPrev">‚óÄ</button>
        <h2 class="month-title" id="calTitle">‚Äî</h2>
        <button class="icon-btn" id="calNext">‚ñ∂</button>
      </div>
      <div class="cal-weekdays">${RU_DOW.map(d=>`<div>${d.toUpperCase()}</div>`).join('')}</div>
      <div class="calendar-wrap"><div class="calendar-grid" id="calendarGrid"></div></div>
    </section>

    <section id="statsView" class="view">
      <h2 class="screen-title" style="padding:6px 6px 0 6px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
      <div class="stats-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;padding:10px;">
        <div class="card" style="background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:12px;text-align:center">
          <div class="ring">
            <svg viewBox="0 0 120 120"><circle class="ring-bg" cx="60" cy="60" r="52"/><circle class="ring-fg" id="ringFg" cx="60" cy="60" r="52"/></svg>
            <div class="ring-center"><div class="ring-pct" id="ringPct">0%</div></div>
          </div>
          <div class="card-caption">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
        </div>
        <div class="card" style="background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:12px">
          <b id="stat7">0 / 0</b><div class="card-caption">–ó–∞ 7 –¥–Ω–µ–π</div>
        </div>
        <div class="card" style="background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:12px">
          <b id="stat30">0 / 0</b><div class="card-caption">–ó–∞ –º–µ—Å—è—Ü</div>
        </div>
        <div class="card" style="background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:12px">
          <b id="streak">0</b><div class="card-caption">–°–µ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</div>
        </div>
      </div>
      <div style="padding:0 10px 80px"><canvas id="miniBars" height="120" style="width:100%"></canvas></div>
    </section>

    <section id="settingsView" class="view">
      <h2 class="screen-title" style="padding:6px 10px 0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <div class="card" style="background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:12px;margin:10px">
        <div class="field"><label>–ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç</label> <input type="color" id="accentPicker" value="#5b5bf0"></div>
        <div class="field-row"><label class="muted" style="min-width:140px;">–ù–µ–æ–Ω-—ç—Ñ—Ñ–µ–∫—Ç</label> <input type="checkbox" id="neonToggle"></div>
        <div class="field-row"><label class="muted" style="min-width:140px;">–ú–µ—Ç–∞–ª–ª–∏—á–Ω–æ—Å—Ç—å</label> <input type="checkbox" id="metalToggle"></div>
        <div class="field"><label>–ú–∞—Å—à—Ç–∞–± —Ç–µ–∫—Å—Ç–∞</label> <input type="range" id="fontScale" min="0.9" max="1.2" step="0.01" value="1"></div>
      </div>
    </section>

    <dialog class="modal" id="addDialog"></dialog>
    <dialog class="modal" id="reschedDialog"></dialog>
  `;

  // Topbar refs
  const topTitle = $('#topTitle');
  const navPrev = $('#navPrev');
  const navNext = $('#navNext');

  // View refs
  const scroller = $('#dateScroller');
  const timeline = $('#timeline');
  const taskList = $('#taskList');
  const kpi = $('#kpiCounter');

  const calTitle = $('#calTitle');
  const calGrid  = $('#calendarGrid');
  const calPrev  = $('#calPrev');
  const calNext  = $('#calNext');

  const ringFg = $('#ringFg');
  const ringPct = $('#ringPct');

  const tabbar = $('#tabbar');
  const views = {
    today: $('#todayView'),
    calendar: $('#calendarView'),
    stats: $('#statsView'),
    settings: $('#settingsView'),
  };

  const fab = $('#fab');

  // Load state
  try {
    const raw = localStorage.getItem(storeKey);
    if (raw) {
      const data = JSON.parse(raw);
      if (data.selectedDate) state.selectedDate = fromKey(data.selectedDate);
      if (data.monthCursor) state.monthCursor = fromKey(data.monthCursor);
      if (Array.isArray(data.items)) state.items = data.items;
      if (data.settings) state.settings = {...state.settings, ...data.settings};
    }
  } catch(e){ console.warn('state load fail', e); }

  // Seed demo if no items for selected day (—á—Ç–æ–±—ã –Ω–µ –≤—ã–≥–ª—è–¥–µ—Ç—å –ø—É—Å—Ç–æ)
  const todayKey = toKey(state.selectedDate);
  if (!state.items.some(i => i.dateKey === todayKey)) {
    state.items.push(
      {id:'d1', type:'event', dateKey:todayKey, title:'–í—Å—Ç—Ä–µ—á–∞', start:'10:00', durationMin:90, priority:'high'},
      {id:'d2', type:'task',  dateKey:todayKey, title:'–ü—Ä–æ—á–∏—Ç–∞—Ç—å 20 —Å—Ç—Ä–∞–Ω–∏—Ü', priority:'medium', done:false},
      {id:'d3', type:'task',  dateKey:todayKey, title:'–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', priority:'low',    done:false},
    );
    persist();
  }

  // Utilities
  const capMonth = d => { const m = RU_MON[d.getMonth()]; return m[0].toUpperCase()+m.slice(1); };
  const getAccent = () => state.settings.accent || '#5b5bf0';
  const setAccent = v => { document.documentElement.style.setProperty('--accent', v); state.settings.accent=v; persist(); };

  function persist(){
    localStorage.setItem(storeKey, JSON.stringify({
      ...state,
      selectedDate: toKey(state.selectedDate),
      monthCursor: toKey(state.monthCursor)
    }));
  }

  // Rendering
  function renderTop(){
    topTitle.textContent = `${capMonth(state.selectedDate)} ${state.selectedDate.getFullYear()} –≥.`;
  }

  function renderScroller(){
    scroller.innerHTML = '';
    const center = state.selectedDate;
    const start = addDays(center, -3);
    for(let i=0;i<7;i++){
      const d = addDays(start, i);
      const b = document.createElement('button');
      b.className = 'date-pill'+(toKey(d)===toKey(center)?' is-active':'');
      b.innerHTML = `<div class="dow">${RU_DOW[d.getDay()].toUpperCase()}</div><div class="day" style="font:800 22px/1.1 Impact">${d.getDate()}</div><div class="mon">${RU_MON[d.getMonth()].slice(0,3)}.</div>`;
      b.addEventListener('click', ()=>{ state.selectedDate=startDay(d); persist(); renderAllToday(); });
      scroller.appendChild(b);
    }
  }

  const DAY_START = 6*60; // 06:00
  const DAY_END   = 22*60;

  function renderTimeline(){
    // –≤—ã—Å–æ—Ç—É –¥–µ–ª–∞–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π (16 —á–∞—Å–æ–≤ * 60px) ‚Äî 960px
    timeline.style.height = `${(DAY_END - DAY_START)}px`;
    timeline.innerHTML = '';
    // —á–∞—Å–æ–≤—ã–µ –º–µ—Ç–∫–∏
    for (let h=6; h<=22; h++){
      const y = h*60 - DAY_START;
      const lbl = document.createElement('div');
      lbl.className = 'time-label';
      lbl.style.top = `${y}px`;
      lbl.textContent = `${fmt2(h)}:00`;
      timeline.appendChild(lbl);
    }
    // —Å–æ–±—ã—Ç–∏—è
    const items = state.items.filter(i => i.type==='event' && i.dateKey===toKey(state.selectedDate));
    items.forEach(ev=>{
      const [hh,mm] = (ev.start||'06:00').split(':').map(Number);
      const top = (hh*60+mm) - DAY_START;
      const h   = Math.max(30, ev.durationMin||60);
      const el = document.createElement('div');
      el.className='event';
      el.style.cssText = `position:absolute;left:56px;right:12px;top:${top}px;height:${h}px;background:rgba(91,91,240,.12);border-left:3px solid ${getAccent()};border-radius:8px;padding:6px 8px;`;
      el.innerHTML = `<div class="ttl" style="font-weight:700">${ev.title}</div><div class="meta" style="color:#667">${ev.start} ‚Ä¢ ${ev.durationMin||60} –º–∏–Ω</div>`;
      timeline.appendChild(el);
    });
  }

  function renderTasks(){
    taskList.innerHTML='';
    const tasks = state.items.filter(i => i.type==='task' && i.dateKey===toKey(state.selectedDate));
    kpi.textContent = tasks.length? `–ó–∞–¥–∞—á: ${tasks.filter(t=>t.done).length} / ${tasks.length}` : '';
    tasks.forEach(t=>{
      const li = document.createElement('li');
      li.className = 'task-row'+(t.done?' task-done':'');
      li.dataset.id = t.id;
      li.innerHTML = `
        <div class="title" style="font-weight:700">${t.title}</div>
        <div class="meta"  style="color:#667">–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${t.priority||'medium'}</div>
        <div class="task-actions">
          <button class="icon-small" data-act="done">‚úì</button>
          <button class="icon-small" data-act="move">‚Üî</button>
          <button class="icon-small" data-act="del">üóë</button>
        </div>`;
      taskList.appendChild(li);

      li.querySelector('[data-act="done"]').onclick = ()=>toggleDone(t.id);
      li.querySelector('[data-act="del"]').onclick  = ()=>delItem(t.id);
      li.querySelector('[data-act="move"]').onclick = ()=>openReschedule(t);

      // swipe: –≤–ø—Ä–∞–≤–æ ‚Äî done, –≤–ª–µ–≤–æ ‚Äî –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏
      attachSwipe(li,{right:()=>toggleDone(t.id), left:()=>openReschedule(t)});
    });
  }

  function renderCalendar(){
    calTitle.textContent = `${capMonth(state.monthCursor)} ${state.monthCursor.getFullYear()} –≥.`;
    calGrid.innerHTML='';
    const first = new Date(state.monthCursor.getFullYear(), state.monthCursor.getMonth(), 1);
    const start = new Date(first); start.setDate(1 - ((first.getDay()+6)%7)); // monday grid
    for(let i=0;i<42;i++){
      const d = addDays(start,i);
      const c = document.createElement('button');
      c.className = 'cal-cell';
      if (d.getMonth()!==state.monthCursor.getMonth()) c.classList.add('is-out');
      if (toKey(d)===toKey(new Date())) c.classList.add('is-today');
      if (toKey(d)===toKey(state.selectedDate)) c.classList.add('is-selected');
      c.textContent = d.getDate();
      c.onclick = ()=>{ state.selectedDate=startDay(d); persist(); switchTab('today'); };
      calGrid.appendChild(c);
    }
  }

  function renderStats(){
    const last7 = [...Array(7)].map((_,i)=>addDays(new Date(), -6+i));
    const done7 = last7.map(d => state.items.filter(x=>x.type==='task' && x.dateKey===toKey(d) && x.done).length);
    const all7  = last7.map(d => state.items.filter(x=>x.type==='task' && x.dateKey===toKey(d)).length);
    const s7=sum(done7), a7=sum(all7);
    $('#stat7').textContent = `${s7} / ${a7}`;
    $('#stat30').textContent = `${s7} / ${a7}`; // —É–ø—Ä–æ—â—ë–Ω–Ω–æ
    const pct = a7? Math.round(s7/a7*100) : 0;
    ringPct.textContent = `${pct}%`;
    const C = 2*Math.PI*52;
    ringFg.style.strokeDasharray = C;
    ringFg.style.strokeDashoffset = C - C*pct/100;

    const cv = $('#miniBars'), ctx = cv.getContext && cv.getContext('2d');
    if (ctx){ const w = cv.width = cv.clientWidth||300; const h = cv.height;
      ctx.clearRect(0,0,w,h); const bw=Math.floor(w/9); const max=Math.max(1,...done7);
      ctx.fillStyle = getAccent();
      done7.forEach((v,i)=>{ const x=(i+1)*bw, bh=(v/max)*(h-24); ctx.fillRect(x,h-8-bh,bw*0.6,bh); });
    }
  }

  function renderAllToday(){ renderTop(); renderScroller(); renderTimeline(); renderTasks(); }

  // CRUD
  function toggleDone(id){ const it = state.items.find(x=>x.id===id); if(!it) return; it.done=!it.done; persist(); renderAllToday(); renderStats(); }
  function delItem(id){ state.items = state.items.filter(x=>x.id!==id); persist(); renderAllToday(); renderStats(); }

  // Swipe helper
  function attachSwipe(el,{left,right}){
    let x0=0,dx=0,act=false;
    const start = e=>{ x0=(e.touches?e.touches[0].clientX:e.clientX); dx=0; act=true; el.style.transition='none'; };
    const move  = e=>{ if(!act) return; const x=(e.touches?e.touches[0].clientX:e.clientX); dx=x-x0; el.style.transform=`translateX(${dx}px)`; };
    const end   = ()=>{ if(!act) return; act=false; el.style.transition=''; const fired=Math.abs(dx)>80; el.style.transform=''; if(!fired) return; dx>0? right&&right() : left&&left(); };
    el.addEventListener('touchstart',start,{passive:true});
    el.addEventListener('touchmove',move,{passive:true});
    el.addEventListener('touchend',end);
    el.addEventListener('mousedown',start);
    window.addEventListener('mousemove',move);
    window.addEventListener('mouseup',end);
  }

  // Reschedule dialog (–º–∏–Ω–∏–º–∞–ª)
  let rsId=null;
  function openReschedule(item){
    rsId=item.id;
    const dlg = $('#reschedDialog');
    dlg.innerHTML = `
      <div class="modal-card">
        <div class="modal-head" style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏</h3><button class="icon-btn" id="rsClose">‚úï</button>
        </div>
        <div class="grid-2">
          <div class="field"><label>–î–∞—Ç–∞</label><input type="date" id="rsDate" value="${item.dateKey}"></div>
          <div class="field"><label>–í—Ä–µ–º—è</label><input type="time" id="rsTime" value="${item.start||'06:00'}"></div>
        </div>
        <div class="modal-foot" style="display:flex;justify-content:flex-end;gap:8px">
          <button class="icon-btn" id="rsCancel">–û—Ç–º–µ–Ω–∞</button>
          <button class="icon-btn" id="rsApply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
      </div>`;
    dlg.showModal();
    $('#rsClose').onclick = $('#rsCancel').onclick = ()=>{ dlg.close(); rsId=null; renderTasks(); };
    $('#rsApply').onclick = ()=>{
      const it = state.items.find(x=>x.id===rsId); if(!it) return;
      it.dateKey = $('#rsDate').value;
      if (it.type==='event') it.start = $('#rsTime').value;
      persist(); dlg.close(); rsId=null; renderAllToday();
    };
  }

  // Add dialog (–º–∏–Ω–∏–º–∞–ª)
  function openAdd(){
    const dlg = $('#addDialog');
    dlg.innerHTML = `
      <div class="modal-card">
        <div class="modal-head" style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">–ù–æ–≤–æ–µ</h3><button class="icon-btn" id="dlgClose">‚úï</button>
        </div>
        <div class="field-row seg" style="display:flex;gap:8px">
          <label><input type="radio" name="kind" value="task" checked> –ó–∞–¥–∞—á–∞</label>
          <label><input type="radio" name="kind" value="event"> –°–æ–±—ã—Ç–∏–µ</label>
        </div>
        <div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="title"></div>
        <div class="grid-2">
          <div class="field"><label>–î–∞—Ç–∞</label><input type="date" id="date" value="${toKey(state.selectedDate)}"></div>
          <div class="field"><label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
            <select id="prio"><option value="low">–ù–∏–∑–∫–∏–π</option><option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option><option value="high">–í—ã—Å–æ–∫–∏–π</option></select>
          </div>
        </div>
        <div id="evBlk" class="grid-2">
          <div class="field"><label>–ù–∞—á–∞–ª–æ</label><input type="time" id="start" value="06:00"></div>
          <div class="field"><label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</label><input type="number" id="dur" min="15" step="15" value="60"></div>
        </div>
        <div class="modal-foot" style="display:flex;justify-content:flex-end;gap:8px">
          <button class="icon-btn" id="dlgCancel">–û—Ç–º–µ–Ω–∞</button>
          <button class="icon-btn" id="dlgSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>`;
    dlg.showModal();
    const toggle = ()=>{ const kind = $('input[name="kind"]:checked', dlg).value; $('#evBlk').style.display = kind==='event'?'grid':'none'; };
    dlg.addEventListener('change', e=>{ if(e.target.name==='kind') toggle(); });
    toggle();
    $('#dlgClose').onclick = $('#dlgCancel').onclick = ()=>dlg.close();
    $('#dlgSave').onclick = ()=>{
      const kind = $('input[name="kind"]:checked', dlg).value;
      const title = $('#title', dlg).value.trim(); if(!title) return dlg.close();
      const data = { id: String(Date.now()+Math.random()), type:kind, title, dateKey: $('#date',dlg).value, priority: $('#prio',dlg).value, done:false };
      if (kind==='event'){ data.start = $('#start',dlg).value; data.durationMin = clamp(parseInt($('#dur',dlg).value||60,10),15,24*60); }
      state.items.push(data); persist(); dlg.close(); renderAllToday();
    };
  }

  // Navigation
  function switchTab(tab){
    Object.entries(views).forEach(([k,v])=>v.classList.toggle('is-active', k===tab));
    $$('.tab', tabbar).forEach(b=>b.classList.toggle('is-active', b.dataset.tab===tab));
    if (tab==='today') renderAllToday();
    if (tab==='calendar') renderCalendar();
    if (tab==='stats') renderStats();
    persist();
  }

  // Events
  navPrev.onclick = ()=>{ state.selectedDate = addDays(state.selectedDate, -1); persist(); renderAllToday(); };
  navNext.onclick = ()=>{ state.selectedDate = addDays(state.selectedDate,  1); persist(); renderAllToday(); };
  calPrev.onclick = ()=>{ const d=state.monthCursor; state.monthCursor=new Date(d.getFullYear(), d.getMonth()-1, 1); persist(); renderCalendar(); };
  calNext.onclick = ()=>{ const d=state.monthCursor; state.monthCursor=new Date(d.getFullYear(), d.getMonth()+1, 1); persist(); renderCalendar(); };
  tabbar.onclick = e=>{ const b=e.target.closest('[data-tab]'); if(!b) return; switchTab(b.dataset.tab); };
  fab.onclick = openAdd;

  // Settings
  const accentPicker = $('#accentPicker');
  const neonToggle = $('#neonToggle');
  const metalToggle= $('#metalToggle');
  const fontScale  = $('#fontScale');

  if (accentPicker){ accentPicker.value = state.settings.accent || '#5b5bf0'; accentPicker.oninput = e=> setAccent(e.target.value); }
  if (neonToggle){ neonToggle.onchange = e=> document.body.classList.toggle('neon', e.target.checked); }
  if (metalToggle){ metalToggle.onchange = e=> document.body.classList.toggle('metallic', e.target.checked); }
  if (fontScale){ fontScale.oninput = e=>{ document.body.style.fontSize = (16*parseFloat(e.target.value))+'px'; }; }

  // Init
  setAccent(state.settings.accent);
  renderAllToday();
})();
