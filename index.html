/* Weepl App.js ‚Äî safe build v1.6.0 (no nested backticks anywhere) */
(function(){
  // ---------- tiny utils ----------
  var $ = function(s, r){ return (r||document).querySelector(s); };
  var $$ = function(s, r){ return Array.prototype.slice.call((r||document).querySelectorAll(s)); };
  var pad2 = function(n){ return String(n).padStart(2,'0'); };
  var keyOf = function(d){ return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); };
  var fromKey = function(k){ var a=k.split('-'); return new Date(+a[0], +a[1]-1, +a[2]); };
  var addDays = function(d,n){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()+n); };
  var startDay = function(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); };
  var clamp = function(n,a,b){ return Math.max(a, Math.min(b,n)); };

  var RU_MON = ["—è–Ω–≤–∞—Ä—å","—Ñ–µ–≤—Ä–∞–ª—å","–º–∞—Ä—Ç","–∞–ø—Ä–µ–ª—å","–º–∞–π","–∏—é–Ω—å","–∏—é–ª—å","–∞–≤–≥—É—Å—Ç","—Å–µ–Ω—Ç—è–±—Ä—å","–æ–∫—Ç—è–±—Ä—å","–Ω–æ—è–±—Ä—å","–¥–µ–∫–∞–±—Ä—å"];
  var RU_DOW = ["–≤—Å","–ø–Ω","–≤—Ç","—Å—Ä","—á—Ç","–ø—Ç","—Å–±"];
  function capMonth(d){ var m = RU_MON[d.getMonth()]; return m.charAt(0).toUpperCase()+m.slice(1); }

  // ---------- state ----------
  var STORE = "weepl_v1";
  var state = {
    selectedDate: startDay(new Date()),
    monthCursor: startDay(new Date()),
    items: [],
    settings: { accent:"#5b5bf0", neon:false, metal:false, fontScale:1 }
  };

  // try load
  try{
    var raw = localStorage.getItem(STORE);
    if(raw){
      var data = JSON.parse(raw);
      if(data.selectedDate) state.selectedDate = fromKey(data.selectedDate);
      if(data.monthCursor) state.monthCursor = fromKey(data.monthCursor);
      if(Array.isArray(data.items)) state.items = data.items;
      if(data.settings) state.settings = Object.assign(state.settings, data.settings);
    }
  }catch(e){ console.warn("load fail", e); }

  function persist(){
    localStorage.setItem(STORE, JSON.stringify({
      selectedDate: keyOf(state.selectedDate),
      monthCursor: keyOf(state.monthCursor),
      items: state.items,
      settings: state.settings
    }));
  }

  // ---------- mount skeleton (no backticks) ----------
  var root = $("#viewContainer");
  if(!root){ console.error("no #viewContainer"); return; }

  var html = "";
  html += '<section id="todayView" class="view is-active">';
  html += '  <div class="date-scroller" id="dateScroller"></div>';
  html += '  <div class="timeline-wrap"><div class="timeline" id="timeline"></div></div>';
  html += '  <div class="tasklist-wrap"><div class="section-head"><h2>–ó–∞–¥–∞—á–∏</h2><div id="kpiCounter"></div></div><ul id="taskList" class="task-list"></ul></div>';
  html += '</section>';

  html += '<section id="calendarView" class="view">';
  html += '  <div class="cal-head"><button class="icon-btn" id="calPrev">‚óÄ</button><h2 class="month-title" id="calTitle">‚Äî</h2><button class="icon-btn" id="calNext">‚ñ∂</button></div>';
  html += '  <div class="cal-weekdays" id="calWeekdays"></div>';
  html += '  <div class="calendar-wrap"><div id="calendarGrid" class="calendar-grid"></div></div>';
  html += '</section>';

  html += '<section id="statsView" class="view">';
  html += '  <h2 class="screen-title" style="padding:8px 16px 0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>';
  html += '  <div class="card" style="margin:10px 16px;padding:12px;text-align:center">';
  html += '    <div class="ring"><svg viewBox="0 0 120 120"><circle class="ring-bg" cx="60" cy="60" r="52"></circle><circle class="ring-fg" id="ringFg" cx="60" cy="60" r="52"></circle></svg><div class="ring-center"><div id="ringPct" class="ring-pct">0%</div></div></div>';
  html += '    <div class="card-caption">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é</div>';
  html += '  </div>';
  html += '  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;padding:0 16px 10px">';
  html += '    <div class="card" style="padding:12px"><b id="stat7">0 / 0</b><div class="card-caption">–ó–∞ 7 –¥–Ω–µ–π</div></div>';
  html += '    <div class="card" style="padding:12px"><b id="stat30">0 / 0</b><div class="card-caption">–ó–∞ –º–µ—Å—è—Ü</div></div>';
  html += '    <div class="card" style="padding:12px"><b id="streak">0</b><div class="card-caption">–°–µ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</div></div>';
  html += '  </div>';
  html += '  <div style="padding:0 16px 100px"><canvas id="miniBars" height="120" style="width:100%"></canvas></div>';
  html += '</section>';

  html += '<section id="settingsView" class="view">';
  html += '  <h2 class="screen-title" style="padding:8px 16px 0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>';
  html += '  <div class="card" style="margin:10px 16px;padding:12px">';
  html += '    <div class="field"><label>–ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç</label><input type="color" id="accentPicker" value="#5b5bf0"></div>';
  html += '    <div class="field-row"><label class="muted" style="min-width:140px">–ù–µ–æ–Ω-—ç—Ñ—Ñ–µ–∫—Ç</label><input type="checkbox" id="neonToggle"></div>';
  html += '    <div class="field-row"><label class="muted" style="min-width:140px">–ú–µ—Ç–∞–ª–ª–∏—á–Ω–æ—Å—Ç—å</label><input type="checkbox" id="metalToggle"></div>';
  html += '    <div class="field"><label>–ú–∞—Å—à—Ç–∞–± —Ç–µ–∫—Å—Ç–∞</label><input type="range" id="fontScale" min="0.9" max="1.2" step="0.01" value="1"></div>';
  html += '  </div>';
  html += '</section>';

  html += '<dialog id="addDialog" class="modal"></dialog>';
  html += '<dialog id="reschedDialog" class="modal"></dialog>';

  root.innerHTML = html;

  // ---------- refs ----------
  var topTitle = $("#topTitle");
  var scroller = $("#dateScroller");
  var timeline = $("#timeline");
  var taskList = $("#taskList");
  var kpi       = $("#kpiCounter");
  var ringFg    = $("#ringFg");
  var ringPct   = $("#ringPct");

  var calTitle  = $("#calTitle");
  var calGrid   = $("#calendarGrid");
  var calPrev   = $("#calPrev");
  var calNext   = $("#calNext");

  // weekdays header (static)
  var wd = $("#calWeekdays");
  var wdHtml = "";
  for (var i=0;i<7;i++){ wdHtml += '<div>'+RU_DOW[i].toUpperCase()+'</div>'; }
  wd.innerHTML = wdHtml;

  // ---------- helpers ----------
  function setAccent(v){
    document.documentElement.style.setProperty('--accent', v);
    state.settings.accent = v; persist();
  }
  setAccent(state.settings.accent);
  document.documentElement.style.setProperty('--fontScale', state.settings.fontScale);

  // ---------- renderers ----------
  function renderTop(){ topTitle.textContent = capMonth(state.selectedDate)+' '+state.selectedDate.getFullYear()+' –≥.'; }

  function renderScroller(){
    scroller.innerHTML = "";
    var center = state.selectedDate;
    var start  = addDays(center, -3);
    for (var i=0;i<7;i++){
      var d = addDays(start, i);
      var btn = document.createElement('button');
      btn.className = 'date-pill'+(keyOf(d)===keyOf(center)?' is-active':'');
      btn.innerHTML =
        '<div class="dow">'+RU_DOW[d.getDay()].toUpperCase()+'</div>'+
        '<div class="day" style="font:800 26px/1 Impact">'+d.getDate()+'</div>'+
        '<div class="mon">'+RU_MON[d.getMonth()].slice(0,3)+'.</div>';
      (function(dd){ btn.onclick = function(){ state.selectedDate = startDay(dd); persist(); renderAllToday(); }; })(d);
      scroller.appendChild(btn);
    }
  }

  var DAY_START = 6*60, DAY_END = 22*60;
  function todayKey(){ return keyOf(state.selectedDate); }

  function renderTimeline(){
    timeline.style.height = (DAY_END-DAY_START)+'px';
    timeline.innerHTML = "";
    for (var h=6; h<=22; h++){
      var y = h*60 - DAY_START;
      var lbl = document.createElement('div');
      lbl.className = 'time-label';
      lbl.style.top = y+'px';
      lbl.textContent = pad2(h)+':00';
      timeline.appendChild(lbl);
    }
    var evs = state.items.filter(function(x){ return x.type==='event' && x.dateKey===todayKey(); });
    for (var i=0;i<evs.length;i++){
      var ev = evs[i];
      var hm = (ev.start||'06:00').split(':');
      var top = (+hm[0])*60 + (+hm[1]) - DAY_START;
      var height = Math.max(30, ev.durationMin||60);
      var el = document.createElement('div');
      el.className = 'event';
      el.style.left='56px'; el.style.right='12px';
      el.style.top = top+'px'; el.style.height = height+'px';
      el.style.background='rgba(91,91,240,.12)';
      el.style.borderLeft='3px solid var(--accent)';
      el.style.borderRadius='8px'; el.style.padding='6px 8px';
      el.innerHTML = '<div class="ttl" style="font-weight:700">'+(ev.title||'–°–æ–±—ã—Ç–∏–µ')+'</div>'+
                     '<div class="meta" style="color:#667">'+(ev.start||'06:00')+' ‚Ä¢ '+(ev.durationMin||60)+' –º–∏–Ω</div>';
      timeline.appendChild(el);
    }
  }

  function renderTasks(){
    taskList.innerHTML = "";
    var tasks = state.items.filter(function(x){ return x.type==='task' && x.dateKey===todayKey(); });
    var doneN = tasks.filter(function(t){return !!t.done;}).length;
    kpi.textContent = tasks.length ? (doneN+' / '+tasks.length) : '';
    tasks.forEach(function(t){
      var li = document.createElement('li');
      li.className = 'task-row'+(t.done?' task-done':'');
      li.dataset.id = t.id;
      li.innerHTML =
        '<div class="title">'+t.title+'</div>'+
        '<div class="meta">–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: '+(t.priority||'medium')+'</div>'+
        '<div class="task-actions">'+
          '<button class="icon-small" data-act="done">‚úì</button>'+
          '<button class="icon-small" data-act="move">‚Üî</button>'+
          '<button class="icon-small" data-act="del">üóë</button>'+
        '</div>';
      li.querySelector('[data-act="done"]').onclick = function(){ toggleDone(t.id); };
      li.querySelector('[data-act="del"]').onclick  = function(){ removeItem(t.id); };
      li.querySelector('[data-act="move"]').onclick = function(){ openReschedule(t); };
      attachSwipe(li, { right:function(){ toggleDone(t.id); }, left:function(){ openReschedule(t); } });
      taskList.appendChild(li);
    });
  }

  function renderCalendar(){
    calTitle.textContent = capMonth(state.monthCursor)+' '+state.monthCursor.getFullYear()+' –≥.';
    calGrid.innerHTML = "";
    var first = new Date(state.monthCursor.getFullYear(), state.monthCursor.getMonth(), 1);
    var start = new Date(first); start.setDate(1 - ((first.getDay()+6)%7)); // Monday-first grid
    for (var i=0;i<42;i++){
      var d = addDays(start,i);
      var b = document.createElement('button');
      b.className = 'cal-cell';
      if (d.getMonth()!==state.monthCursor.getMonth()) b.classList.add('is-out');
      if (keyOf(d)===keyOf(new Date())) b.classList.add('is-today');
      if (keyOf(d)===keyOf(state.selectedDate)) b.classList.add('is-selected');
      b.textContent = d.getDate();
      (function(dd){ b.onclick=function(){ state.selectedDate=startDay(dd); persist(); switchTab('today'); }; })(d);
      calGrid.appendChild(b);
    }
  }

  function renderStats(){
    var days=[], i;
    for(i=6;i>=0;i--) days.push(addDays(new Date(), -i));
    var done7 = days.map(function(d){
      var k = keyOf(d);
      return state.items.filter(function(x){ return x.type==='task' && x.dateKey===k && x.done; }).length;
    });
    var all7 = days.map(function(d){
      var k = keyOf(d);
      return state.items.filter(function(x){ return x.type==='task' && x.dateKey===k; }).length;
    });
    var s7 = done7.reduce(function(a,b){return a+b;},0);
    var a7 = all7.reduce(function(a,b){return a+b;},0);
    $("#stat7").textContent = s7+' / '+a7;
    $("#stat30").textContent = s7+' / '+a7;
    var pct = a7 ? Math.round(s7/a7*100) : 0;
    ringPct.textContent = pct+'%';
    var C = 2*Math.PI*52;
    ringFg.style.strokeDasharray = C;
    ringFg.style.strokeDashoffset = C - C*pct/100;

    var cv = $("#miniBars"), ctx = cv.getContext && cv.getContext('2d');
    if(ctx){
      var w = cv.width = cv.clientWidth||300, h = cv.height;
      ctx.clearRect(0,0,w,h);
      var bw = Math.floor(w/9), max = Math.max(1, Math.max.apply(null, done7));
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#5b5bf0';
      done7.forEach(function(v,idx){
        var x = (idx+1)*bw, bh = (v/max)*(h-24);
        ctx.fillRect(x, h-8-bh, bw*0.6, bh);
      });
    }
  }

  function renderAllToday(){ renderTop(); renderScroller(); renderTimeline(); renderTasks(); }

  // ---------- actions ----------
  function toggleDone(id){
    var it = state.items.find(function(x){ return x.id===id; });
    if(!it) return; it.done = !it.done; persist(); renderAllToday(); renderStats();
  }
  function removeItem(id){
    state.items = state.items.filter(function(x){ return x.id!==id; });
    persist(); renderAllToday(); renderStats();
  }

  function attachSwipe(el, handlers){
    var x0=0, dx=0, active=false;
    function start(e){ active=true; x0=(e.touches?e.touches[0].clientX:e.clientX); el.style.transition='none'; }
    function move(e){ if(!active) return; var x=(e.touches?e.touches[0].clientX:e.clientX); dx=x-x0; el.style.transform='translateX('+dx+'px)'; }
    function end(){ if(!active) return; active=false; el.style.transition=''; var fire=Math.abs(dx)>80; el.style.transform=''; if(!fire) return; if(dx>0 && handlers.right) handlers.right(); if(dx<0 && handlers.left) handlers.left(); }
    el.addEventListener('touchstart',start,{passive:true});
    el.addEventListener('touchmove',move,{passive:true});
    el.addEventListener('touchend',end);
    el.addEventListener('mousedown',start);
    window.addEventListener('mousemove',move);
    window.addEventListener('mouseup',end);
  }

  // reschedule dialog (—Å ¬´–û—Ç–º–µ–Ω–∞¬ª –Ω–µ —É–¥–∞–ª—è–µ—Ç –Ω–∏—á–µ–≥–æ)
  var resId=null;
  function openReschedule(item){
    resId=item.id;
    var dlg = $("#reschedDialog");
    var s = '';
    s += '<div class="modal-card">';
    s += ' <div class="row" style="justify-content:space-between"><b>–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–¥–∞—á—É</b>';
    s += ' <button class="btn btn-ghost" id="rsClose">√ó</button></div>';
    s += ' <div class="row" style="margin-top:10px;gap:8px">';
    s += '   <button class="btn btn-ghost" data-add="1">+1 –¥–µ–Ω—å</button>';
    s += '   <button class="btn btn-ghost" data-add="3">+3 –¥–Ω—è</button>';
    s += '   <button class="btn btn-ghost" data-add="7">+7 –¥–Ω–µ–π</button>';
    s += ' </div>';
    s += ' <div style="margin-top:10px;text-align:right"><button class="btn" id="rsCancel">–û—Ç–º–µ–Ω–∞</button></div>';
    s += '</div>';
    dlg.innerHTML = s;
    dlg.showModal();
    dlg.querySelector('#rsClose').onclick = function(){ dlg.close(); };
    dlg.querySelector('#rsCancel').onclick = function(){ dlg.close(); };
    $$('#reschedDialog [data-add]').forEach(function(b){
      b.onclick = function(){
        var add = +b.getAttribute('data-add');
        var it = state.items.find(function(x){return x.id===resId;});
        if(it){
          var d = fromKey(it.dateKey);
          it.dateKey = keyOf(addDays(d, add));
          persist(); renderAllToday(); renderCalendar();
        }
        dlg.close();
      };
    });
  }

  // add dialog (–∑–∞–¥–∞—á–∞/—Å–æ–±—ã—Ç–∏–µ)
  function openAdd(){
    var dlg = $("#addDialog");
    var s = '';
    s += '<div class="modal-card">';
    s += '<div class="row" style="justify-content:space-between"><b>–ù–æ–≤–æ–µ</b><button class="btn btn-ghost" id="addClose">√ó</button></div>';
    s += '<div style="display:grid;gap:8px;margin-top:10px">';
    s += '  <input id="addTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="padding:10px;border-radius:12px;border:1px solid #e5e8f2">';
    s += '  <div class="row"><label><input type="radio" name="kind" value="task" checked> –ó–∞–¥–∞—á–∞</label>';
    s += '       <label style="margin-left:12px"><input type="radio" name="kind" value="event"> –°–æ–±—ã—Ç–∏–µ</label></div>';
    s += '  <div class="row" id="eventFields" style="display:none;gap:8px">';
    s += '    <input id="evStart" value="10:00" style="padding:8px;border-radius:10px;border:1px solid #e5e8f2;width:90px">';
    s += '    <input id="evDur" value="60" style="padding:8px;border-radius:10px;border:1px solid #e5e8f2;width:90px"><span class="muted">–º–∏–Ω</span>';
    s += '  </div>';
    s += '  <div class="row"><label class="muted">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>';
    s += '    <select id="prio" style="padding:8px;border-radius:10px;border:1px solid #e5e8f2"><option>low</option><option selected>medium</option><option>high</option></select>';
    s += '  </div>';
    s += '</div>';
    s += '<div style="margin-top:12px;text-align:right"><button class="btn btn-accent" id="addOk">–î–æ–±–∞–≤–∏—Ç—å</button></div>';
    s += '</div>';
    dlg.innerHTML = s;
    dlg.showModal();
    dlg.querySelector('#addClose').onclick = function(){ dlg.close(); };

    var kindRadios = $$('#addDialog [name="kind"]');
    function syncEv(){ var k=[].find.call(kindRadios, function(r){return r.checked;}).value; $('#eventFields').style.display = (k==='event'?'flex':'none'); }
    kindRadios.forEach(function(r){ r.onchange = syncEv; }); syncEv();

    dlg.querySelector('#addOk').onclick = function(){
      var title = $('#addTitle').value.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
      var k = [].find.call(kindRadios, function(r){return r.checked;}).value;
      var pr = $('#prio').value;
      if(k==='task'){
        state.items.push({id:'t'+Date.now(), type:'task',  dateKey: todayKey(), title:title, priority:pr, done:false});
      }else{
        var st = $('#evStart').value || '10:00';
        var du = clamp(parseInt($('#evDur').value,10)||60, 15, 24*60);
        state.items.push({id:'e'+Date.now(), type:'event', dateKey: todayKey(), title:title, start:st, durationMin:du, priority:pr});
      }
      persist(); dlg.close(); renderAllToday(); renderStats();
    };
  }

  // ---------- tabbar ----------
  function switchTab(id){
    Object.keys(views).forEach(function(k){ views[k].classList.remove('is-active'); });
    views[id].classList.add('is-active');
    if(id==='calendar') renderCalendar();
    if(id==='stats') renderStats();
    if(id==='today') renderAllToday();
  }
  var views = {
    today:    $('#todayView'),
    calendar: $('#calendarView'),
    stats:    $('#statsView'),
    settings: $('#settingsView'),
  };
  $('#tabToday').onclick    = function(){ switchTab('today'); };
  $('#tabCalendar').onclick = function(){ switchTab('calendar'); };
  $('#tabStats').onclick    = function(){ switchTab('stats'); };
  $('#tabSettings').onclick = function(){ switchTab('settings'); };
  $('#fab').onclick         = openAdd;

  // calendar arrows
  calPrev.onclick = function(){ state.monthCursor = addDays(state.monthCursor, -28); persist(); renderCalendar(); };
  calNext.onclick = function(){ state.monthCursor = addDays(state.monthCursor, +28); persist(); renderCalendar(); };

  // settings hooks
  var ap = $('#accentPicker'), nt = $('#neonToggle'), mt = $('#metalToggle'), fs = $('#fontScale');
  if(ap){ ap.value = state.settings.accent; ap.oninput = function(){ setAccent(ap.value); }; }
  if(nt){ nt.checked = !!state.settings.neon;  nt.onchange = function(){ state.settings.neon = nt.checked; persist(); }; }
  if(mt){ mt.checked = !!state.settings.metal; mt.onchange = function(){ state.settings.metal = mt.checked; persist(); }; }
  if(fs){ fs.value = state.settings.fontScale; fs.oninput = function(){ state.settings.fontScale = +fs.value; document.documentElement.style.setProperty('--fontScale', fs.value); persist(); }; }

  // seed demo if empty today
  if(!state.items.some(function(x){ return x.dateKey===todayKey(); })){
    state.items.push({id:'d1',type:'task',title:'–°—ã–≥—Ä–∞—Ç—å –≤ –≤–æ–ª–µ–π–±–æ–ª',dateKey:todayKey(),priority:'medium',done:false});
    persist();
  }

  // initial
  renderAllToday(); renderCalendar(); renderStats();

})();
